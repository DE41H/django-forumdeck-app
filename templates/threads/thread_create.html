{% extends 'base.html' %}

{% block content %}
<div class="mb-4">
    <a href="{% url 'threads:thread_list' slug=category.slug order_by='-created_at' %}" class="btn btn-white border shadow-sm px-3 py-1 text-muted fw-bold small rounded-pill">
        <i class="bi bi-arrow-left me-1"></i> Cancel
    </a>
</div>

<div class="widget-box p-5 border-0 shadow-sm">
    <div class="mb-4 pb-4 border-bottom">
        <h1 class="fw-bold h3 text-dark mb-1">Start a Discussion</h1>
        <p class="text-secondary mb-0">Share your thoughts in <strong>{{ category.name }}</strong>.</p>
    </div>

    <form method="post">
        {% csrf_token %}

        {% if form.errors %}
            <div class="mb-4">
                {% for field, errors in form.errors.items %}
                    {% for error in errors %}
                        <div class="alert alert-danger border-0 py-2 px-3 small">{{ field|title }}: {{ error }}</div>
                    {% endfor %}
                {% endfor %}
            </div>
        {% endif %}

        <div class="mb-4">
            <label class="sidebar-label text-dark mb-2">Title</label>
            {{ form.title }}
        </div>

        <div class="mb-4">
            <label class="sidebar-label text-dark mb-2">Content</label>
            {{ form.raw_content }}
            <div class="form-text mt-1">Markdown is supported.</div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <label class="sidebar-label text-dark mb-2">Related Courses</label>
                {{ form.tagged_courses }}
            </div>
            <div class="col-md-6">
                <label class="sidebar-label text-dark mb-2">Related Documents</label>
                {{ form.tagged_documents }}
            </div>
        </div>

        <div class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <label class="sidebar-label text-dark mb-0">Topics</label>
                <a href="{% url 'threads:tag_create' %}?next={{ request.path }}" class="small fw-bold text-decoration-none text-primary">
                    <i class="bi bi-plus-circle me-1"></i> Create New Topic
                </a>
            </div>
            {{ form.tags }}
            <div class="form-text">Select relevant topics for this discussion.</div>
        </div>

        <div class="d-flex justify-content-end">
            <button type="submit" class="btn btn-dark fw-bold px-5 py-2">Post Discussion</button>
        </div>
    </form>
</div>

<style>
    .ts-control {
        border: 1px solid #dee2e6;
        padding: 12px;
        border-radius: 8px;
        box-shadow: none;
        background-color: #FAFAFA;
    }
    .ts-control.focus {
        border-color: #000;
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
    }
    .ts-dropdown {
        border-radius: 8px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        border: 1px solid #f3f4f6;
    }
    textarea { min-height: 200px; }
    
    input:focus, textarea:focus {
        background-color: #fff;
        border-color: #000;
        outline: 0;
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
    }
</style>

<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // 1. Tags Configuration (Creation Disabled Here)
        if(document.getElementById('id_tags')) {
            new TomSelect("#id_tags", {
                plugins: ['remove_button'],
                maxItems: 5,
                placeholder: "Select topics...",
                create: false, // Force user to use the 'Create New Topic' link
                render: {
                    item: function(data, escape) {
                        return '<div>' + escape(data.text) + '</div>';
                    }
                }
            });
        }
        
        // 2. Courses Configuration
        if(document.getElementById('id_tagged_courses')) {
            new TomSelect("#id_tagged_courses", {
                plugins: ['remove_button'],
                maxItems: 5,
                placeholder: "Search for courses...",
                create: false 
            });
        }
        
        // 3. Documents Configuration
        if(document.getElementById('id_tagged_documents')) {
            new TomSelect("#id_tagged_documents", {
                plugins: ['remove_button'],
                maxItems: 5,
                placeholder: "Search for documents...",
                create: false 
            });
        }
    });
</script>
{% endblock %}

{% block right_sidebar %}
<div class="mb-4">
    <label class="sidebar-label">Guidelines</label>
    <div class="widget-box p-4">
        <ul class="list-unstyled mb-0 text-muted small d-flex flex-column gap-3">
            <li><strong>1. Be Respectful</strong><br>Treat others with kindness.</li>
            <li><strong>2. Stay on Topic</strong><br>Keep discussion relevant.</li>
            <li><strong>3. No Spam</strong><br>Avoid excessive self-promotion.</li>
        </ul>
    </div>
</div>
{% endblock %}