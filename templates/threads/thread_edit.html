{% extends 'base.html' %}

{% block title %}Edit Discussion{% endblock %}

{% block content %}
<div class="mb-4">
    <a href="{% url 'threads:thread_detail' pk=thread.pk order_by='-created_at' %}" class="btn btn-white border shadow-sm px-3 py-1 text-muted fw-bold small rounded-pill">
        <i class="bi bi-arrow-left me-1"></i> Cancel
    </a>
</div>

<div class="widget-box p-5 border-0 shadow-sm">
    <div class="mb-4 pb-4 border-bottom">
        <h1 class="fw-bold h3 text-dark mb-1">Edit Discussion</h1>
        <p class="text-secondary mb-0">Update your thread details below.</p>
    </div>

    <form method="post">
        {% csrf_token %}

        {% if form.errors %}
        <div class="alert alert-danger border-0 rounded-3 mb-4 p-3 bg-danger bg-opacity-10 text-danger">
            <div class="fw-bold mb-1"><i class="bi bi-exclamation-triangle-fill me-2"></i>Please fix the errors below:</div>
            <ul class="mb-0 small ps-4">
                {% for field in form %}
                    {% for error in field.errors %}<li>{{ field.label }}: {{ error }}</li>{% endfor %}
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="mb-4">
            <label class="sidebar-label text-dark mb-2">Title</label>
            {{ form.title }}
        </div>

        <div class="mb-4">
            <label class="sidebar-label text-dark mb-2">Content</label>
            {{ form.raw_content }}
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <label class="sidebar-label text-dark mb-2">Related Courses</label>
                {{ form.tagged_courses }}
            </div>
            <div class="col-md-6">
                <label class="sidebar-label text-dark mb-2">Related Documents</label>
                {{ form.tagged_documents }}
            </div>
        </div>

        <div class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <label class="sidebar-label text-dark mb-0">Topics</label>
                <a href="{% url 'threads:tag_create' %}?next={{ request.path }}" class="small fw-bold text-decoration-none text-primary">
                    <i class="bi bi-plus-circle me-1"></i> Create New Topic
                </a>
            </div>
            {{ form.tags }}
        </div>

        <div class="d-flex justify-content-end gap-2">
            <button type="submit" class="btn btn-dark fw-bold px-5 py-2">Save Changes</button>
        </div>
    </form>
</div>

<style>
    .ts-control {
        border: 1px solid #dee2e6;
        padding: 12px;
        border-radius: 8px;
        background-color: #FAFAFA;
    }
    textarea { min-height: 250px; }
    
    input:focus, textarea:focus, select:focus {
        background-color: #fff;
        border-color: #000;
        outline: 0;
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
    }
</style>

<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        if(document.getElementById('id_tags')) {
            new TomSelect("#id_tags", {
                plugins: ['remove_button'],
                maxItems: 5,
                placeholder: "Select or search topics...",
                create: false, 
            });
        }
        
        if(document.getElementById('id_tagged_courses')) {
            new TomSelect("#id_tagged_courses", {
                plugins: ['remove_button'],
                maxItems: 5,
                placeholder: "Search courses...",
                create: false, 
            });
        }
        
        if(document.getElementById('id_tagged_documents')) {
            new TomSelect("#id_tagged_documents", {
                plugins: ['remove_button'],
                maxItems: 5,
                placeholder: "Search documents...",
                create: false, 
            });
        }
    });
</script>
{% endblock %}